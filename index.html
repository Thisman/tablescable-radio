<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff4081">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tablescable Radio</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
            background: #000;
            color: #fff;
        }
        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        .content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
        }
        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 30px;
            background: #ff4081;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #e91e63;
        }
        @media (max-width: 600px) {
            .btn {
                font-size: 1em;
                padding: 10px 20px;
            }
        }
        audio {
            display: none;
        }
    </style>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(101739249, "init", {
                clickmap:true,
                trackLinks:true,
                accurateTrackBounce:true
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/101739249" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
</head>
<body>
    <canvas id="visualizer"></canvas>
    <div class="content">
        <h1>Tablescable Radio</h1>
        <button class="btn" id="playButton">Слушать Радио</button>
        <button class="btn" id="stopButton">Остановить</button>
    </div>
    <audio id="audio" crossorigin="anonymous" src="https://radio.tablescable-radio.ru/stream"></audio>

    <script>
        const audio = document.getElementById('audio');
        const playButton = document.getElementById('playButton');
        const stopButton = document.getElementById('stopButton');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        let w, h;

        stopButton.style.display = 'none';

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        playButton.addEventListener('click', () => {
            audio.play().catch(e => console.warn(e));
            playButton.style.display = 'none';
            stopButton.style.display = 'inline-block';
            initVisualizer();
        });

        stopButton.addEventListener('click', () => {
            audio.pause();
            stopButton.style.display = 'none';
            playButton.style.display = 'inline-block';
        });

        function initVisualizer() {
            let audioCtx, source, analyser;
            let fallbackPhase = 0;
            let fallbackSpeed = 0.05;
            let fallback = false;
            const fallbackDelay = 1000; // 5000 мс = 5 секунд
            let silentStart = null;

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                source = audioCtx.createMediaElementSource(audio);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
            } catch (e) {
                console.warn('Web Audio API не поддерживается, fallback сразу включен');
                analyser = null;
                fallback = true;
            }

            const bufferLength = analyser ? analyser.frequencyBinCount : 64;
            const dataArray = new Uint8Array(bufferLength);

            function animate() {
                if (analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    const avg = dataArray.reduce((a, b) => a + b, 0) / bufferLength;

                    if (avg < 5) {
                        if (!silentStart) {
                            silentStart = Date.now();
                        } else if (Date.now() - silentStart >= fallbackDelay) {
                            fallback = true;
                        }
                    } else {
                        silentStart = null;
                        fallback = false;
                    }
                }

                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(0, 0, w, h);

                const barWidth = w / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    let barHeight;

                    if (fallback || !analyser) {
                        // barHeight = (Math.sin(fallbackPhase + i * 0.2) * 0.5 + 0.5) * h * 0.4;
                        barHeight = (
                            (Math.sin(fallbackPhase + i * 0.2) +
                            Math.sin(fallbackPhase * 1.5 + i * 0.5)) * 0.25 + 0.5
                        ) * h * 0.4;
                        // barHeight = (Math.abs(((fallbackPhase + i * 0.2) % (2 * Math.PI)) - Math.PI) / Math.PI) * h * 0.4;
                        // barHeight = ((fallbackPhase + i * 0.2) % (2 * Math.PI)) / (2 * Math.PI) * h * 0.4;
                        // if (Math.random() < 0.05) {
                        //     barHeight = Math.random() * h * 0.4;
                        // }
                    } else {
                        barHeight = dataArray[i] / 255 * h * 0.5;
                    }

                    const hue = i / bufferLength * 360;
                    ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    ctx.fillRect(x, h - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }

                fallbackPhase += fallbackSpeed;
                requestAnimationFrame(animate);
            }
            animate();
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('Service worker registered:', reg.scope))
                .catch(err => console.error('Service worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
